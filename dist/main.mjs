import{Y as YAML,c as coreExports}from"./deps.mjs";import fs from"node:fs/promises";import path from"node:path";import"os";import"fs";import"path";import"http";import"https";import"net";import"tls";import"events";import"assert";import"util";import"stream";import"buffer";import"querystring";import"stream/web";import"node:stream";import"node:util";import"node:events";import"worker_threads";import"perf_hooks";import"util/types";import"async_hooks";import"console";import"url";import"zlib";import"string_decoder";import"diagnostics_channel";const env=process.env,GITHUB_TOKEN=env.GITHUB_TOKEN,[GITHUB_OWNER,GITHUB_REPO]=env.GITHUB_REPOSITORY?.split("/")??[];const githubRepo=new class GithubRepo{constructor(owner,repo,token){this.owner=owner,this.repo=repo,this.token=token,this.#headers=new Headers({accept:"application/vnd.github.v3+json"}),token&&this.#headers.append("authorization","token "+token)}#headers;async listGitHubTags(tagPrefix=""){const{owner:owner,repo:repo}=this,resp=await fetch(`https://api.github.com/repos/${owner}/${repo}/git/matching-refs/tags/${tagPrefix}`,{headers:this.#headers});if(resp.ok){return(await resp.json()).map((item=>item.ref.slice(10)))}throw new Error(resp.statusText)}}(GITHUB_OWNER,GITHUB_REPO,GITHUB_TOKEN);await async function main(){const file=coreExports.getInput("json");let versions;if(file.startsWith(".")||file.startsWith("/")){const field=coreExports.getInput("field"),prefix=coreExports.getInput("prefix");versions=await async function getVersion(jsonpath,field,prefix){jsonpath=path.resolve(jsonpath);const json=await async function readfile(filename){const text=await fs.readFile(filename,"utf-8"),{ext:ext}=path.parse(filename);switch(ext){case".json":return JSON.parse(text);case".yaml":case".yml":return YAML.parse(text);default:throw new Error("无法解析扩展名："+filename)}}(jsonpath).catch((e=>{throw new Error("json 文件读取失败："+jsonpath,{cause:e})})),version=json?.[field];if("string"==typeof version)return[version];if(version instanceof Array)return prefix?version.map((val=>prefix+val)):version;throw new Error(`JSON '${field}' 字段(${typeof version}) 不存在或格式错误`)}(file,field,prefix)}else versions=await function getPreset(preset){throw new Error("不支持预设："+preset)}(file);versions=await async function filterNoExistTags(tags){if(0===tags.length)return[];const allTags=new Set(await githubRepo.listGitHubTags());return tags.filter((tag=>!allTags.has(tag)))}(versions),versions.length?(coreExports.setOutput("tags",JSON.stringify(versions)),console.log("Tags: "+versions.join(", "))):console.log("No tags")}();